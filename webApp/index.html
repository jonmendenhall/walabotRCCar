<!DOCTYPE html>
<html>
<head>
	<title>Walabot RCCars</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link href="https://fonts.googleapis.com/css?family=Roboto:500" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>


<div class="leftPane">
	<div class="carSelect" onclick="selectCar(0)"><span>Red Car</span></div>
	<div class="carSelect" onclick="selectCar(1)"><span>Blue Car</span></div>
	<div id="carSelection" class="carSelection"></div>
</div>
<div class="midPane">
	<div class="midHolder">
		<canvas id="speedCanvas"></canvas>
		<div class="speedHolder">
			<span id="speed">50</span>
			<span class="speedUnits">Throttle %</span>
		</div>
	</div>
</div>
<div class="rightPane">
	<div class="gearSelect" onclick="selectGear(0)"><span>P</span></div>
	<div class="gearSelect" onclick="selectGear(1)"><span>R</span></div>
	<div class="gearSelect" onclick="selectGear(2)"><span>N</span></div>
	<div class="gearSelect" onclick="selectGear(3)"><span>D</span></div>
	<div id="gearSelection" class="gearSelection"></div>
</div>
<script>


// Variables for User Interface

var steering = 0
var currentCar = 0
var currentGear = 0
var throttle = 0

// Called when you choose 'Red Car' or 'Blue Car' on the left of the screen

function selectCar(i) {
	document.getElementById("carSelection").style.top = i * 50 + "%"
	currentCar = i
	send([1, currentCar]) // Send a select car command... [1, Car#]
}

function selectGear(i) {
	document.getElementById("gearSelection").style.top = i * 25 + "%"
	currentGear = i
	if(currentGear == 0 || currentGear == 2) // Park, Neutral
		throttle = 0
	if(currentGear == 0) { // Park
		window.removeEventListener("deviceorientation", deviceOrientationHandler) // we dont want steering control, so disconnect the motion handler
	} else { // Reverse, Neutral, Drive
		window.addEventListener("deviceorientation", deviceOrientationHandler) // now we want steering control, so connect the motion handler
	}
	send([2, currentGear]) // Send a select gear command... [2, Gear#]
}


// Canvas element that will show the speed guage

var canvas = document.getElementById("speedCanvas")
canvas.width = 400
canvas.height = 400
var ctx = canvas.getContext("2d")

// Animate will draw the glowing arc representing Throttle Percent

var progress = 0
function animate() {
	requestAnimationFrame(animate)
	ctx.clearRect(0, 0, 400, 400)
	ctx.lineWidth = 12

	var color = "rgb(170, 51, 247)" // Base color to use for the glowing arc

	// Creates a gradient that fades on the edges of the arc to make a glow effect

	var glow = ctx.createRadialGradient(200, 200, 0, 200, 200, 200)
	glow.addColorStop(0.81, "rgba(0, 0, 0, 0)")
	glow.addColorStop(0.81, "rgba(0, 0, 0, 1)")
	glow.addColorStop(0.9, color)
	glow.addColorStop(0.99, "rgba(0, 0, 0, 1)")
	glow.addColorStop(0.99, "rgba(0, 0, 0, 0)")

	// Draw the full arc in a dark gray color

	ctx.strokeStyle = "#222"
	ctx.beginPath()
	ctx.arc(200, 200, 200 * 0.9, Math.PI * 0.75, Math.PI * (0.75 + 1 * 1.5), false)
	ctx.stroke()

	// Smoothly interpolates between what throttle is shown, and what throttle it should be at

	progress += (throttle - progress) * 0.1
	document.getElementById("speed").innerHTML = (progress * 100).toFixed(0)

	// Fill a portion of the arc for the gradient to make a glow on the edges

	ctx.fillStyle = glow
	ctx.beginPath()
	ctx.arc(200, 200, 200, Math.PI * 0.75, Math.PI * (0.75 + progress * 1.5), false)
	ctx.lineTo(200, 200)
	ctx.fill()

	// Draw the arc in the solid base color

	ctx.strokeStyle = color
	ctx.beginPath()
	ctx.arc(200, 200, 200 * 0.9, Math.PI * 0.75, Math.PI * (0.75 + progress * 1.5), false)
	ctx.stroke() 

	// If we're in Reverse, Neutral, or Drive, send the current steering value based on the gyroscopes. (Not in Park)

	if(currentGear > 0)
		send([3, Math.round(steering)])
}

// Begin the render and control loop

animate()


// Setup a WebSocket connection to the Raspberry Pi
// To get the address of your RPi, run 'hostname' on the ssh terminal, it will give you the name of your Raspberry Pi

var ws = new WebSocket("ws://raspberrypi2.local:8080") // this address should be 'ws://[hostname].local:8080'
ws.binaryType = "arraybuffer"

// When we receive a throttle message from the Raspberry Pi, only display it on the guage if we're in Reverse, or Drive.

ws.onmessage = function(e) {
	if(currentGear == 0 || currentGear == 2)
		return
	var buf = new Uint8Array(e.data)
	throttle = buf[0] / 255
}

// Function to send a data packet (array) to the server for controlling

function send(data) {
	if(!ws.readyState)
		return
	var bytes = Uint8Array.from(data)
	ws.send(bytes)
}


// Handles the accelerometer/gyroscope feedback from the WebBrowser

function deviceOrientationHandler(e) {
	steering = Math.min(Math.max(e.beta, -60), 60) // corrosponds to rotating the device like a steering wheel with a min and max of 60 degrees.
}

</script>
</body>
</html>